# fix-claude-jsonl

Claude CodeのセッションログファイルでタイムスタンプがUTCとJSTで混在したりしていると、時系列に矛盾が生じることがあるため、それを修正するスクリプトです。

## 概要

Claude Codeの会話ログ（JSONLファイル）内の以下の問題を修正します：

1. **タイムスタンプの時系列矛盾**: UTCとJSTの混在等で時系列に矛盾のあるエントリのタイムスタンプ値を修正
2. **親子UUID関係の不整合**: 会話エントリ間の親子関係（parentUuid）が正しく連鎖していない場合に修正

このスクリプトはプロジェクトの`.claude/settings.json`でStopイベントのHookとして設定されており、会話終了時に自動的に実行されます。

## 使用方法

### 手動実行
```bash
node scripts/fix-claude-jsonl/dist/fix-jsonl.js <jsonl-file-path>
```

### 自動実行（Hook経由）
プロジェクトの`.claude/settings.json`で設定済みです。Claude Codeの会話終了時に自動的に実行されます。

## 機能

### 1. タイムスタンプ修正
1. JSONLファイルの各行を解析
2. タイムスタンプフィールドを検出
3. 時系列矛盾のあるエントリを特定（前のエントリより古いタイムスタンプ）
4. 矛盾したタイムスタンプ値を論理的に正しい値に修正
   - 次のエントリがある場合：前後エントリの中間時刻を計算
   - 次のエントリがない場合：前のエントリ+1秒に設定

### 2. 親子UUID修正
1. 各エントリの`uuid`と`parentUuid`を検証
2. 現在のエントリの`parentUuid`が前のエントリの`uuid`と一致しない場合を検出
3. 正しい親子関係になるよう`parentUuid`を修正
4. 会話の連続性と参照関係を適切に保持

## ビルド方法

```bash
cd scripts/fix-claude-jsonl
npm install
npm run build
```

## 注意事項

- タイムスタンプがないエントリはそのまま保持されます
- エントリの順序は変更せず、タイムスタンプ値のみを修正します
- 親子UUID関係も元の順序を基に適切に修正されます
- パースエラーの行はスキップされます